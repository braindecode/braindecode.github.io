

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Process a big data EEG resource (TUH EEG Corpus) &mdash; Braindecode 0.5.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Benchmarking eager and lazy loading" href="benchmark_lazy_eager_loading.html" />
    <link rel="prev" title="Sleep staging on the Sleep Physionet dataset" href="plot_sleep_staging.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Braindecode
          

          
          </a>

          
            
            
              <div class="version">
                0.5.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="plot_bcic_iv_2a_moabb_trial.html"> Basic trialwise decoding</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_bcic_iv_2a_moabb_cropped.html"> More data-efficient &quot;cropped decoding&quot;</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_mne_dataset_example.html"> Your own datasets through MNE</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_custom_dataset_example.html"> Your own datasets through Numpy</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Braindecode examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="plot_split_dataset.html">Split Dataset Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_custom_dataset_example.html">Custom Dataset Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_load_save_datasets.html">Load and save dataset example</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_mne_dataset_example.html">MNE Dataset Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_dataset_example.html">MOABB Dataset Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_regression.html">Regression example on fake data</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_sleep_staging.html">Sleep staging on the Sleep Physionet dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_bcic_iv_2a_moabb_trial.html">Trialwise Decoding on BCIC IV 2a Dataset</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_bcic_iv_2a_moabb_cropped.html">Cropped Decoding on BCIC IV 2a Dataset</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Process a big data EEG resource (TUH EEG Corpus)</a></li>
<li class="toctree-l2"><a class="reference internal" href="benchmark_lazy_eager_loading.html">Benchmarking eager and lazy loading</a></li>
<li class="toctree-l2"><a class="reference internal" href="plot_relative_positioning.html">Self-supervised learning on EEG with relative positioning</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../whats_new.html">What’s new</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Braindecode</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Braindecode examples</a> &raquo;</li>
        
      <li>Process a big data EEG resource (TUH EEG Corpus)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/auto_examples/tuh_eeg_corpus.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-tuh-eeg-corpus-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="process-a-big-data-eeg-resource-tuh-eeg-corpus">
<span id="sphx-glr-auto-examples-tuh-eeg-corpus-py"></span><h1>Process a big data EEG resource (TUH EEG Corpus)<a class="headerlink" href="#process-a-big-data-eeg-resource-tuh-eeg-corpus" title="Permalink to this headline">¶</a></h1>
<p>In this example, we showcase usage of the Temple University Hospital EEG Corpus
(<a class="reference external" href="https://www.isip.piconepress.com/projects/tuh_eeg/html/downloads.shtml#c_tueg">https://www.isip.piconepress.com/projects/tuh_eeg/html/downloads.shtml#c_tueg</a>)
including simple preprocessing steps as well as cutting of compute windows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Author: Lukas Gemein &lt;l.gemein@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1"># License: BSD (3-clause)</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">mne</span>

<span class="kn">from</span> <span class="nn">braindecode.datasets</span> <span class="kn">import</span> <a href="../generated/braindecode.datasets.TUH.html#braindecode.datasets.TUH" title="braindecode.datasets.TUH" class="sphx-glr-backref-module-braindecode-datasets sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">TUH</span></a>
<span class="kn">from</span> <span class="nn">braindecode.datautil.preprocess</span> <span class="kn">import</span> <a href="../generated/braindecode.datautil.preprocess.html#braindecode.datautil.preprocess" title="braindecode.datautil.preprocess" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">preprocess</span></a><span class="p">,</span> <a href="../generated/braindecode.datautil.Preprocessor.html#braindecode.datautil.Preprocessor" title="braindecode.datautil.Preprocessor" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Preprocessor</span></a>
<span class="kn">from</span> <span class="nn">braindecode.datautil.windowers</span> <span class="kn">import</span> <a href="../generated/braindecode.datautil.create_fixed_length_windows.html#braindecode.datautil.create_fixed_length_windows" title="braindecode.datautil.create_fixed_length_windows" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">create_fixed_length_windows</span></a>
<span class="kn">from</span> <span class="nn">braindecode.datautil.serialization</span> <span class="kn">import</span> <span class="p">(</span>
    <a href="../generated/braindecode.datautil.save_concat_dataset.html#braindecode.datautil.save_concat_dataset" title="braindecode.datautil.save_concat_dataset" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">save_concat_dataset</span></a><span class="p">,</span> <a href="../generated/braindecode.datautil.load_concat_dataset.html#braindecode.datautil.load_concat_dataset" title="braindecode.datautil.load_concat_dataset" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">load_concat_dataset</span></a><span class="p">)</span>

<a href="https://mne.tools/stable/generated/mne.set_log_level.html#mne.set_log_level" title="mne.set_log_level" class="sphx-glr-backref-module-mne sphx-glr-backref-type-py-function"><span class="n">mne</span><span class="o">.</span><span class="n">set_log_level</span></a><span class="p">(</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span>  <span class="c1"># avoid messages everytime a window is extracted</span>
</pre></div>
</div>
<p>We start by creating a TUH dataset. First, the class generates a description
of the recordings in <cite>TUH_PATH</cite> (which is later accessible as
<cite>tuh.description</cite>) without actually touching the files. This will parse
information from file paths such as patient id, recording data, etc and should
be really fast. Afterwards, the files are sorted chronologically by year,
month, day, patient id, recording session and segment.
In the following, a subset of the description corresponding to <cite>recording_ids</cite>
is used.
Afterwards, the files will be iterated a second time, slower than before.
The files are now actually touched. Additional information about subjects
like age and gender are parsed directly from the EDF file header. If existent,
the physician report is added to the description. Furthermore, the recordings
are read with <cite>mne.io.read_raw_edf</cite> with <cite>preload=False</cite>. Finally, we will get
a <cite>BaseConcatDataset</cite> of <cite>BaseDatasets</cite> each holding a single
<cite>nme.io.Raw</cite> which is fully compatible with other braindecode functionalities.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TUH_PATH</span> <span class="o">=</span> <span class="s1">&#39;/home/lukas/Downloads/tuh_eeg_sample/&#39;</span>
<span class="n">tuh</span> <span class="o">=</span> <a href="../generated/braindecode.datasets.TUH.html#braindecode.datasets.TUH" title="braindecode.datasets.TUH" class="sphx-glr-backref-module-braindecode-datasets sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">TUH</span></a><span class="p">(</span>
    <span class="n">path</span><span class="o">=</span><span class="n">TUH_PATH</span><span class="p">,</span>
    <span class="n">recording_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">target_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">preload</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">add_physician_reports</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can easily create descriptive statistics using the description <cite>DataFrame</cite>,
for example an age histogram split by gender of patients.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <a href="https://matplotlib.org/api/_as_gen/matplotlib.pyplot.subplots.html#matplotlib.pyplot.subplots" title="matplotlib.pyplot.subplots" class="sphx-glr-backref-module-matplotlib-pyplot sphx-glr-backref-type-py-function"><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span></a><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">genders</span> <span class="o">=</span> <span class="n">tuh</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">gender</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">tuh</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">age</span><span class="p">[</span><span class="n">tuh</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">gender</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">genders</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
    <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.arange.html#numpy.arange" title="numpy.arange" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">np</span><span class="o">.</span><span class="n">arange</span></a><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">genders</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we will perform some preprocessing steps. First, we will do some
selection of available recordings based on the duration. We will select those
recordings, that have at least five minutes duration. Data is not loaded here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select_by_duration</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># determine length of the recordings and select based on tmin and tmax</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">/</span> <span class="n">ds</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">sfreq</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="p">[</span><span class="n">duration</span> <span class="o">&gt;=</span> <span class="n">tmin</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">tmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmax</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/constants.html#numpy.inf" title="numpy.inf" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-data"><span class="n">np</span><span class="o">.</span><span class="n">inf</span></a>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">duration</span><span class="p">[</span><span class="n">duration</span> <span class="o">&lt;=</span> <span class="n">tmax</span><span class="p">]</span>
    <span class="n">split_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split_ids</span><span class="p">)</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">splits</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">split</span>


<span class="n">tmin</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span>
<span class="n">tmax</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">tuh</span> <span class="o">=</span> <span class="n">select_by_duration</span><span class="p">(</span><span class="n">tuh</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we will discard all recordings that have an incomplete channel
configuration (wrt the channels that we are interested in, i.e. the 21
channels of the international 10-20-placement). The dataset is subdivided into
recordings with ‘le’ and ‘ar’ reference which we will have to consider. Data
is not loaded here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">short_ch_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
    <span class="s1">&#39;A1&#39;</span><span class="p">,</span> <span class="s1">&#39;A2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FP1&#39;</span><span class="p">,</span> <span class="s1">&#39;FP2&#39;</span><span class="p">,</span> <span class="s1">&#39;F3&#39;</span><span class="p">,</span> <span class="s1">&#39;F4&#39;</span><span class="p">,</span> <span class="s1">&#39;C3&#39;</span><span class="p">,</span> <span class="s1">&#39;C4&#39;</span><span class="p">,</span> <span class="s1">&#39;P3&#39;</span><span class="p">,</span> <span class="s1">&#39;P4&#39;</span><span class="p">,</span> <span class="s1">&#39;O1&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">,</span>
    <span class="s1">&#39;F7&#39;</span><span class="p">,</span> <span class="s1">&#39;F8&#39;</span><span class="p">,</span> <span class="s1">&#39;T3&#39;</span><span class="p">,</span> <span class="s1">&#39;T4&#39;</span><span class="p">,</span> <span class="s1">&#39;T5&#39;</span><span class="p">,</span> <span class="s1">&#39;T6&#39;</span><span class="p">,</span> <span class="s1">&#39;FZ&#39;</span><span class="p">,</span> <span class="s1">&#39;CZ&#39;</span><span class="p">,</span> <span class="s1">&#39;PZ&#39;</span><span class="p">])</span>
<span class="n">ar_ch_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
    <span class="s1">&#39;EEG A1-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG A2-REF&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG FP1-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG FP2-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG F3-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG F4-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG C3-REF&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG C4-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG P3-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG P4-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG O1-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG O2-REF&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG F7-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG F8-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG T3-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG T4-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG T5-REF&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG T6-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG FZ-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG CZ-REF&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG PZ-REF&#39;</span><span class="p">])</span>
<span class="n">le_ch_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span>
    <span class="s1">&#39;EEG A1-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG A2-LE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG FP1-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG FP2-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG F3-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG F4-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG C3-LE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG C4-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG P3-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG P4-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG O1-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG O2-LE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG F7-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG F8-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG T3-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG T4-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG T5-LE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;EEG T6-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG FZ-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG CZ-LE&#39;</span><span class="p">,</span> <span class="s1">&#39;EEG PZ-LE&#39;</span><span class="p">])</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">short_ch_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ar_ch_names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">le_ch_names</span><span class="p">)</span>
<span class="n">ar_ch_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">ch_name</span><span class="p">:</span> <span class="n">short_ch_name</span> <span class="k">for</span> <span class="n">ch_name</span><span class="p">,</span> <span class="n">short_ch_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">ar_ch_names</span><span class="p">,</span> <span class="n">short_ch_names</span><span class="p">)}</span>
<span class="n">le_ch_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">ch_name</span><span class="p">:</span> <span class="n">short_ch_name</span> <span class="k">for</span> <span class="n">ch_name</span><span class="p">,</span> <span class="n">short_ch_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">le_ch_names</span><span class="p">,</span> <span class="n">short_ch_names</span><span class="p">)}</span>
<span class="n">ch_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ar&#39;</span><span class="p">:</span> <span class="n">ar_ch_mapping</span><span class="p">,</span> <span class="s1">&#39;le&#39;</span><span class="p">:</span> <span class="n">le_ch_mapping</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">select_by_channels</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">ch_mapping</span><span class="p">):</span>
    <span class="n">split_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">datasets</span><span class="p">):</span>
        <span class="n">seta</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ch_mapping</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">reference</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">setb</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">ch_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">seta</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">setb</span><span class="p">):</span>
            <span class="n">split_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">split_ids</span><span class="p">)[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span>


<span class="n">tuh</span> <span class="o">=</span> <span class="n">select_by_channels</span><span class="p">(</span><span class="n">tuh</span><span class="p">,</span> <span class="n">ch_mapping</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we will chain several preprocessing steps that are realized through
<cite>mne</cite>. Data will be loaded by the first preprocessor that has a mention of it
in brackets:
- crop the recordings to a region of interest
- re-reference all recordings to ‘ar’ (requires load)
- rename channels to short channel names
- pick channels of interest
- scale signals to microvolts (requires load)
- resample recordings to a common frequency (requires load)
- create compute windows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">custom_rename_channels</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">mapping</span><span class="p">):</span>
    <span class="c1"># rename channels which are dependent on referencing:</span>
    <span class="c1"># le: EEG 01-LE, ar: EEG 01-REF</span>
    <span class="c1"># mne fails if the mapping contains channels as keys that are not present</span>
    <span class="c1"># in the raw</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">ch_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">reference</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;le&#39;</span><span class="p">,</span> <span class="s1">&#39;ref&#39;</span><span class="p">],</span> <span class="s1">&#39;unexpected referencing&#39;</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="s1">&#39;le&#39;</span> <span class="k">if</span> <span class="n">reference</span> <span class="o">==</span> <span class="s1">&#39;le&#39;</span> <span class="k">else</span> <span class="s1">&#39;ar&#39;</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">rename_channels</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">reference</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">custom_crop</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_tmax</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="c1"># crop recordings to tmin – tmax. can be incomplete if recording</span>
    <span class="c1"># has lower duration than tmax</span>
    <span class="c1"># by default mne fails if tmax is bigger than duration</span>
    <span class="n">tmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">raw</span><span class="o">.</span><span class="n">n_times</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">raw</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">],</span> <span class="n">tmax</span><span class="p">)</span>
    <span class="n">raw</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">include_tmax</span><span class="o">=</span><span class="n">include_tmax</span><span class="p">)</span>


<span class="n">tmin</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">60</span>
<span class="n">tmax</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">60</span>
<span class="n">sfreq</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">preprocessors</span> <span class="o">=</span> <span class="p">[</span>
    <a href="../generated/braindecode.datautil.Preprocessor.html#braindecode.datautil.Preprocessor" title="braindecode.datautil.Preprocessor" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Preprocessor</span></a><span class="p">(</span><span class="n">custom_crop</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">include_tmax</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">apply_on_array</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <a href="../generated/braindecode.datautil.Preprocessor.html#braindecode.datautil.Preprocessor" title="braindecode.datautil.Preprocessor" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Preprocessor</span></a><span class="p">(</span><span class="s1">&#39;set_eeg_reference&#39;</span><span class="p">,</span> <span class="n">ref_channels</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">ch_type</span><span class="o">=</span><span class="s1">&#39;eeg&#39;</span><span class="p">),</span>
    <a href="../generated/braindecode.datautil.Preprocessor.html#braindecode.datautil.Preprocessor" title="braindecode.datautil.Preprocessor" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Preprocessor</span></a><span class="p">(</span><span class="n">custom_rename_channels</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">ch_mapping</span><span class="p">,</span>
                 <span class="n">apply_on_array</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <a href="../generated/braindecode.datautil.Preprocessor.html#braindecode.datautil.Preprocessor" title="braindecode.datautil.Preprocessor" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Preprocessor</span></a><span class="p">(</span><span class="s1">&#39;pick_channels&#39;</span><span class="p">,</span> <span class="n">ch_names</span><span class="o">=</span><span class="n">short_ch_names</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <a href="../generated/braindecode.datautil.Preprocessor.html#braindecode.datautil.Preprocessor" title="braindecode.datautil.Preprocessor" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Preprocessor</span></a><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">),</span>
    <a href="../generated/braindecode.datautil.Preprocessor.html#braindecode.datautil.Preprocessor" title="braindecode.datautil.Preprocessor" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">Preprocessor</span></a><span class="p">(</span><span class="s1">&#39;resample&#39;</span><span class="p">,</span> <span class="n">sfreq</span><span class="o">=</span><span class="n">sfreq</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The preprocessing loop works as follows. For every recording, we apply the
preprocessors as defined above. Then, we update the description of the rec,
since we have altered the duration, the reference, and the sampling frequency.
Afterwards, we split the continuous signals into compute windows. We store
each recording to a unique subdirectory that is named corresponding to the
rec id. To save memory, after windowing and storing, we delete the raw
dataset and the windows dataset, respectively.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">window_size_samples</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">window_stride_samples</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">create_compute_windows</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">out_i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">OUT_PATH</span> <span class="o">=</span> <span class="s1">&#39;./tuh_sample/&#39;</span>
<span class="n">tuh_splits</span> <span class="o">=</span> <span class="n">tuh</span><span class="o">.</span><span class="n">split</span><span class="p">([[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tuh</span><span class="o">.</span><span class="n">datasets</span><span class="p">))])</span>
<span class="k">for</span> <span class="n">rec_i</span><span class="p">,</span> <span class="n">tuh_subset</span> <span class="ow">in</span> <span class="n">tuh_splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="c1"># implement preprocess for BaseDatasets? Would remove necessity</span>
    <span class="c1"># to split above</span>
    <a href="../generated/braindecode.datautil.preprocess.html#braindecode.datautil.preprocess" title="braindecode.datautil.preprocess" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">preprocess</span></a><span class="p">(</span><span class="n">tuh_subset</span><span class="p">,</span> <span class="n">preprocessors</span><span class="p">)</span>

    <span class="c1"># update description of the recording(s)</span>
    <span class="n">tuh_subset</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">sfreq</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tuh_subset</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="n">sfreq</span><span class="p">]</span>
    <span class="n">tuh_subset</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">reference</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tuh_subset</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="s1">&#39;ar&#39;</span><span class="p">]</span>
    <span class="n">tuh_subset</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tuh_subset</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">create_compute_windows</span><span class="p">:</span>
        <span class="c1"># generate compute windows here and store them to disk</span>
        <span class="n">tuh_windows</span> <span class="o">=</span> <a href="../generated/braindecode.datautil.create_fixed_length_windows.html#braindecode.datautil.create_fixed_length_windows" title="braindecode.datautil.create_fixed_length_windows" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">create_fixed_length_windows</span></a><span class="p">(</span>
            <span class="n">tuh_subset</span><span class="p">,</span>
            <span class="n">start_offset_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">stop_offset_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">window_size_samples</span><span class="o">=</span><span class="n">window_size_samples</span><span class="p">,</span>
            <span class="n">window_stride_samples</span><span class="o">=</span><span class="n">window_stride_samples</span><span class="p">,</span>
            <span class="n">drop_last_window</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="c1"># save memory by deleting raw recording</span>
        <span class="k">del</span> <span class="n">tuh_subset</span>
        <span class="c1"># store the number of windows required for loading later on</span>
        <span class="n">tuh_windows</span><span class="o">.</span><span class="n">description</span><span class="p">[</span><span class="s2">&quot;n_windows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span>
                                                <span class="n">tuh_windows</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>

        <span class="c1"># create one directory for every recording</span>
        <span class="n">rec_path</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><span class="n">OUT_PATH</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec_i</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.exists" title="os.path.exists" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span></a><span class="p">(</span><span class="n">rec_path</span><span class="p">):</span>
            <a href="https://docs.python.org/3/library/os.html#os.makedirs" title="os.makedirs" class="sphx-glr-backref-module-os sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span></a><span class="p">(</span><span class="n">rec_path</span><span class="p">)</span>
        <a href="../generated/braindecode.datautil.save_concat_dataset.html#braindecode.datautil.save_concat_dataset" title="braindecode.datautil.save_concat_dataset" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">save_concat_dataset</span></a><span class="p">(</span><span class="n">rec_path</span><span class="p">,</span> <span class="n">tuh_windows</span><span class="p">)</span>
        <span class="n">out_i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># save memory by catching epoched recording</span>
        <span class="k">del</span> <span class="n">tuh_windows</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># store raws to disk for option of using different compute window</span>
        <span class="c1"># sizes</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>We load the preprocessed data again in a lazy fashion (<cite>preload=False</cite>). It is
now ready to be used for model training.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tuh_loaded</span> <span class="o">=</span> <a href="../generated/braindecode.datautil.load_concat_dataset.html#braindecode.datautil.load_concat_dataset" title="braindecode.datautil.load_concat_dataset" class="sphx-glr-backref-module-braindecode-datautil sphx-glr-backref-type-py-function"><span class="n">load_concat_dataset</span></a><span class="p">(</span><span class="s1">&#39;./tuh_sample/&#39;</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<p><strong>Estimated memory usage:</strong>  0 MB</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-tuh-eeg-corpus-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/1d95fa6be1dc71420570b466ed970faf/tuh_eeg_corpus.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">tuh_eeg_corpus.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/8c06a965e21b52d199f98636388aaa21/tuh_eeg_corpus.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">tuh_eeg_corpus.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="benchmark_lazy_eager_loading.html" class="btn btn-neutral float-right" title="Benchmarking eager and lazy loading" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="plot_sleep_staging.html" class="btn btn-neutral float-left" title="Sleep staging on the Sleep Physionet dataset" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018-2021, Braindecode developers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>